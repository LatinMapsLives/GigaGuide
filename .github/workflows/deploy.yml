name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]

env:
  SSH_HOST: ${{ secrets.YC_SSH_HOST }}
  SSH_USER: ${{ secrets.YC_SSH_USER }}
  COMPOSE_PROJECT_NAME: gigaguide

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üîê Install SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.YC_SSH_PRIVATE_KEY }}

      - name: üì§ Copy files to server
        run: |
          rsync -az --exclude='.git' ./ $SSH_USER@$SSH_HOST:/home/$SSH_USER/gigaguide

      - name: üöÄ Build and deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e

            cd /home/$USER/gigaguide

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ docker compose plugin
            if ! docker compose version &>/dev/null; then
              echo "üîß Installing Docker Compose plugin..."
              DOCKER_COMPOSE_VERSION="v2.24.6"
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              curl -SL https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-linux-x86_64 -o docker-compose
              sudo mv docker-compose /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            fi

            docker compose build --pull
            docker compose down
            docker compose up -d --remove-orphans
          EOF
