name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]  # –¢–æ–ª—å–∫–æ push –≤ main

env:
  SSH_HOST: ${{ secrets.YC_SSH_HOST }}
  SSH_USER: ${{ secrets.YC_SSH_USER }}
  REPO: github.com/LatinMapsLives/GigaGuide
  APP_DIR: gigaguide

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.YC_SSH_PRIVATE_KEY }}

      - name: üöÄ Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e

            echo "üìÅ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"
            cd /home/$USER

            echo "üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)"
            rm -rf $APP_DIR

            echo "‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
            git clone https://${REPO} $APP_DIR

            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É —Å docker-compose.yml"
            cd $APP_DIR/application/backend/docker-compose

            echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ docker compose"
            if ! docker compose version &>/dev/null; then
              echo "üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose plugin"
              DOCKER_COMPOSE_VERSION="v2.24.6"
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              curl -SL https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-linux-x86_64 -o docker-compose
              sudo mv docker-compose /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            fi

            echo "‚öôÔ∏è –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫"
            docker compose down
            docker compose up -d --build --remove-orphans

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
          EOF
